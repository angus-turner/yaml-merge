#!/usr/bin/env node

'use strict';
const resolve = require('path').resolve;
const fs = require('fs');
const apiSpecConverter = require('api-spec-converter');
const index = require('../index.js');
const {readAsJSON} = require("../index");
const jsYaml = require('js-yaml');
const {logger} = require("../index");

const files = process.argv
    .slice(2)
    .map((path) => resolve(path));

// convert swagger
apiSpecConverter.convert({
    from: 'openapi_3',
    to: 'swagger_2',
    // source: 'http://localhost:8080/v3/api-docs',
    source: files[0]

}).then(function (convertedJson) {

    // remove xml tags and only select definitions
    // merge updated definitions with original swagger file
    const mergedFile = index.yamlMerge(index.readAsJSON(files[1]), index.cleanupOpenAPI(convertedJson))

    // sort updated merged file
    apiSpecConverter.convert({
        from: 'swagger_2',
        to: 'swagger_2',
        source: jsYaml.load(mergedFile)
    }).then(function (sortedFile) {
        let options = {syntax: 'yaml', order: 'openapi'}
        // write sorted to a file
        fs.writeFile('result.yaml', sortedFile.stringify(options), function (err) {
            if (err) return index.logger.error(err);
            index.logger.info('OutputFile' + sortedFile);
        })
    })
});









